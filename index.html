<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PECS Communication Builder</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --surface: #ffffff;
            --surface-2: #f8fafc;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius: 12px;
            --radius-lg: 16px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 24px;
        }

        .header {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 32px;
            text-align: center;
            box-shadow: var(--shadow-lg);
            margin-bottom: 32px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .header p {
            font-size: 1.125rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .card-header {
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .sentence-area {
            min-height: 120px;
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 20px;
            background: var(--surface-2);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            transition: all 0.2s ease;
            margin-bottom: 20px;
        }

        .sentence-area.drag-over {
            border-color: var(--primary);
            background: #eef2ff;
        }

        .sentence-area.empty::before {
            content: "Drag PECS cards here to build your sentence";
            color: var(--text-muted);
            font-style: italic;
            font-size: 1rem;
        }

        .sentence-image {
            width: 80px;
            height: 80px;
            border-radius: var(--radius);
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
            transition: transform 0.2s ease;
        }

        .sentence-image:hover {
            transform: scale(1.05);
        }

        .sentence-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sentence-image .remove-btn {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
        }

        .controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            box-shadow: var(--shadow);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .image-grid {
            display: block;
            margin-bottom: 24px;
        }

        .pecs-image {
            width: 100px;
            height: 100px;
            border-radius: var(--radius);
            cursor: grab;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 2px solid var(--border);
            transition: all 0.2s ease;
            background: var(--surface);
        }

        .pecs-image:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .pecs-image:active {
            cursor: grabbing;
        }

        .pecs-image img {
            width: 100%;
            height: 80%;
            object-fit: cover;
        }

        .pecs-image .label {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--text);
            color: white;
            padding: 4px;
            text-align: center;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .pecs-remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .pecs-image:hover .pecs-remove-btn {
            opacity: 1;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 32px;
            text-align: center;
            background: var(--surface-2);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #eef2ff;
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .file-input {
            display: none;
        }

        .rename-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .rename-modal {
            background: var(--surface);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .rename-modal-header {
            background: var(--surface-2);
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .rename-modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
        }

        .rename-modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color 0.2s ease;
        }

        .rename-modal-close:hover {
            color: var(--text);
        }

        .rename-modal-body {
            padding: 24px;
            display: grid;
            grid-template-columns: 150px 1fr;
            gap: 24px;
            align-items: start;
        }

        .rename-preview-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            background: var(--surface);
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(99 102 241 / 0.1);
        }

        .rename-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .rename-modal-footer {
            background: var(--surface-2);
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .sentence-builder-card {
            position: sticky;
            top: 24px;
            z-index: 100;
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            margin-bottom: 32px;
        }

        .sentence-builder-card.floating {
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 10px 10px -5px rgb(0 0 0 / 0.1);
            border-color: var(--primary);
        }

        .category-section {
            margin-bottom: 32px;
            padding: 20px;
            background: var(--surface-2);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            position: relative;
        }

        .category-section:last-child {
            margin-bottom: 0;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 0;
        }

        .category-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-delete-btn {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .category-delete-btn:hover {
            opacity: 1;
        }

        .category-edit-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .category-edit-btn:hover {
            opacity: 1;
        }

        .category-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text);
            margin: 0;
        }

        .category-count {
            background: var(--primary);
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .category-content {
            overflow-x: auto;
            padding: 8px 0;
        }

        .category-content::-webkit-scrollbar {
            height: 8px;
        }

        .category-content::-webkit-scrollbar-track {
            background: var(--surface);
            border-radius: 4px;
        }

        .category-content::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        .category-content::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        .category-grid {
            display: flex;
            gap: 16px;
            padding: 4px;
            min-height: 120px;
        }

        .category-grid .pecs-image {
            flex-shrink: 0;
        }

        .pecs-edit-btn {
            position: absolute;
            top: 4px;
            left: 4px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .pecs-image:hover .pecs-edit-btn {
            opacity: 1;
        }

        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: var(--secondary);
            color: white;
            padding: 16px 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            font-size: 0.875rem;
            font-weight: 500;
            max-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header {
                padding: 24px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }
            
            .rename-modal-body {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .rename-preview-image {
                width: 120px;
                height: 120px;
                margin: 0 auto;
            }
            
            .controls {
                flex-wrap: wrap;
            }
            
            .btn {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PECS Communication Builder</h1>
            <p>Build sentences by arranging pictures to communicate your thoughts</p>
        </div>

        <div class="main-content">
            <!-- Sentence Builder -->
            <div class="sentence-builder-card" id="sentenceBuilderCard">
                <div class="card-header">
                    <h2 class="card-title">Build Your Sentence</h2>
                    <p class="card-subtitle">Drag PECS cards here to create your message</p>
                </div>
                <div class="sentence-area" id="sentenceArea"></div>
                <div class="controls">
                    <button class="btn btn-danger" onclick="clearSentence()">Clear</button>
                    <button class="btn btn-primary speak-btn" onclick="speakSentence()">Speak</button>
                </div>
            </div>

            <!-- Picture Library -->
            <div class="card">
                <div class="card-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h2 class="card-title" style="margin-bottom: 0;">Picture Library</h2>
                        <button class="btn btn-secondary" onclick="showCreateCategoryDialog()">+ New Category</button>
                    </div>
                    <p class="card-subtitle">Touch and drag pictures to build your sentence</p>
                </div>
                <div class="image-grid" id="imageGrid"></div>
                
                <!-- Upload Section -->
                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">📁</div>
                    <h3 style="margin-bottom: 8px; font-size: 1rem;">Upload Images</h3>
                    <p style="color: var(--text-muted); font-size: 0.875rem;">Click to select images or drag them here</p>
                    <input type="file" id="imageInput" class="file-input" accept="image/*" multiple>
                </div>
            </div>
        </div>
    </div>

    <script>
        let imageLibrary = [];
        let currentSentence = [];
        let draggedImage = null;
        let customCategories = new Set(); // Track custom categories

        document.addEventListener('DOMContentLoaded', function() {
            loadDefaultImages();
            setupEventListeners();
        });

        function loadDefaultImages() {
            imageLibrary = [];
            
            const defaultImages = [
                { id: 1, label: 'I', src: '/images/default/person.jpg', category: 'People' },
                { id: 2, label: 'want', src: '/images/default/want.jpg', category: 'Actions' },
                { id: 3, label: 'drink', src: '/images/default/drink.jpg', category: 'Meal Time' },
                { id: 4, label: 'food', src: '/images/default/food.jpg', category: 'Meal Time' },
                { id: 5, label: 'help', src: '/images/default/help.jpg', category: 'Actions' },
                { id: 6, label: 'go', src: '/images/default/go.jpg', category: 'Actions' },
                { id: 7, label: 'play', src: '/images/default/play.jpg', category: 'Activities' },
                { id: 8, label: 'stop', src: '/images/default/stop.jpg', category: 'Actions' },
                { id: 9, label: 'more', src: '/images/default/more.jpg', category: 'Descriptors' },
                { id: 10, label: 'finished', src: '/images/default/finished.jpg', category: 'Descriptors' }
            ];

            defaultImages.forEach(img => {
                const imageData = {
                    id: img.id,
                    label: img.label,
                    src: img.src,
                    category: img.category,
                    fallbackSrc: createSimpleIcon(img.label.toLowerCase(), img.label)
                };
                imageLibrary.push(imageData);
            });

            renderImageLibrary();
        }

        function createSimpleIcon(type, label) {
            const svgStart = `<svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                <rect width="120" height="120" fill="#f8fafc"/>`;
            const svgEnd = `</svg>`;
            
            let content = '';
            
            switch(type) {
                case 'empty':
                    content = `<circle cx="60" cy="60" r="25" fill="#e2e8f0" stroke="#94a3b8" stroke-width="2"/>
                        <text x="60" y="50" font-family="Arial" font-size="10" fill="#64748b" text-anchor="middle">Empty</text>
                        <text x="60" y="65" font-family="Arial" font-size="10" fill="#64748b" text-anchor="middle">Category</text>
                        <text x="60" y="80" font-family="Arial" font-size="8" fill="#94a3b8" text-anchor="middle">Add images here</text>`;
                    break;
                case 'i':
                    content = `<circle cx="60" cy="35" r="15" fill="#6366f1"/>
                        <rect x="45" y="55" width="30" height="35" rx="5" fill="#6366f1"/>
                        <rect x="35" y="65" width="15" height="25" rx="3" fill="#6366f1"/>
                        <rect x="70" y="65" width="15" height="25" rx="3" fill="#6366f1"/>`;
                    break;
                case 'want':
                    content = `<circle cx="35" cy="60" r="12" fill="#ef4444"/>
                        <circle cx="85" cy="60" r="12" fill="#ef4444"/>
                        <path d="M55 60 L65 60 M62 57 L65 60 L62 63" stroke="#333" stroke-width="3" fill="none"/>`;
                    break;
                case 'drink':
                    content = `<rect x="40" y="35" width="25" height="40" rx="3" fill="#3b82f6"/>
                        <rect x="42" y="37" width="21" height="20" fill="#93c5fd"/>
                        <path d="M65 45 Q75 45 75 55 Q75 65 65 65" stroke="#333" stroke-width="2" fill="none"/>`;
                    break;
                case 'food':
                    content = `<circle cx="60" cy="65" r="20" fill="#ef4444"/>
                        <rect x="58" y="35" width="4" height="15" fill="#16a34a"/>
                        <ellipse cx="68" cy="42" rx="4" ry="8" fill="#22c55e" transform="rotate(30 68 42)"/>`;
                    break;
                case 'help':
                    content = `<circle cx="45" cy="50" r="15" fill="#f97316"/>
                        <circle cx="75" cy="70" r="15" fill="#10b981"/>
                        <path d="M35 50 L55 50 M45 40 L45 60" stroke="white" stroke-width="4"/>`;
                    break;
                case 'go':
                    content = `<path d="M25 60 L70 60 L60 45 L85 60 L60 75 Z" fill="#dc2626"/>`;
                    break;
                case 'play':
                    content = `<circle cx="60" cy="60" r="18" fill="#8b5cf6"/>
                        <path d="M50 50 L70 70 M70 50 L50 70" stroke="white" stroke-width="2"/>
                        <circle cx="40" cy="40" r="8" fill="#a855f7"/>
                        <circle cx="80" cy="80" r="8" fill="#ec4899"/>`;
                    break;
                case 'stop':
                    content = `<polygon points="60,25 85,40 85,80 60,95 35,80 35,40" fill="#dc2626"/>
                        <text x="60" y="65" font-family="Arial" font-size="12" font-weight="bold" fill="white" text-anchor="middle">STOP</text>`;
                    break;
                case 'more':
                    content = `<circle cx="60" cy="60" r="22" fill="#10b981"/>
                        <path d="M40 60 L80 60 M60 40 L60 80" stroke="white" stroke-width="5"/>`;
                    break;
                case 'finished':
                    content = `<circle cx="60" cy="60" r="22" fill="#ec4899"/>
                        <path d="M45 60 L55 70 L75 50" stroke="white" stroke-width="5" fill="none"/>`;
                    break;
            }
            
            const svgString = svgStart + content + svgEnd;
            return 'data:image/svg+xml;base64,' + btoa(svgString);
        }

        function setupEventListeners() {
            document.getElementById('imageInput').addEventListener('change', handleImageUpload);
            
            const sentenceArea = document.getElementById('sentenceArea');
            sentenceArea.addEventListener('dragover', handleDragOver);
            sentenceArea.addEventListener('drop', handleDrop);
            sentenceArea.addEventListener('dragleave', handleDragLeave);
            sentenceArea.addEventListener('touchstart', handleTouchStart);
            sentenceArea.addEventListener('touchmove', handleTouchMove);
            sentenceArea.addEventListener('touchend', handleTouchEnd);
        }

        function renderImageLibrary() {
            const container = document.getElementById('imageGrid');
            container.innerHTML = '';

            // Group images by category
            const categories = {};
            imageLibrary.forEach(image => {
                const category = image.category || 'Other';
                if (!categories[category]) {
                    categories[category] = [];
                }
                categories[category].push(image);
            });

            // Define category order for better UX
            const categoryOrder = ['People', 'Actions', 'Meal Time', 'Activities', 'Descriptors', 'Other'];
            
            categoryOrder.forEach(categoryName => {
                if (categories[categoryName] && categories[categoryName].length > 0) {
                    createCategorySection(container, categoryName, categories[categoryName]);
                }
            });

            // Add any remaining categories not in the predefined order
            Object.keys(categories).forEach(categoryName => {
                if (!categoryOrder.includes(categoryName) && categories[categoryName].length > 0) {
                    createCategorySection(container, categoryName, categories[categoryName]);
                }
            });
        }

        function createCategorySection(container, categoryName, images) {
            const section = document.createElement('div');
            section.className = 'category-section';
            section.dataset.category = categoryName;

            const header = document.createElement('div');
            header.className = 'category-header';
            
            const isCustomCategory = customCategories.has(categoryName);
            
            header.innerHTML = `
                <div class="category-header-left">
                    <h3 class="category-title">${categoryName}</h3>
                    <span class="category-count">${images.length}</span>
                </div>
                <div class="category-header-right">
                    ${isCustomCategory ? `
                        <button class="category-edit-btn" onclick="editCategoryName('${categoryName}')" title="Edit category name">✎</button>
                        <button class="category-delete-btn" onclick="deleteCategory('${categoryName}')" title="Delete category">×</button>
                    ` : ''}
                </div>
            `;

            const content = document.createElement('div');
            content.className = 'category-content';
            content.id = `category-${categoryName}`;

            const grid = document.createElement('div');
            grid.className = 'category-grid';

            images.forEach(image => {
                const imageElement = document.createElement('div');
                imageElement.className = 'pecs-image';
                imageElement.draggable = true;
                imageElement.dataset.imageId = image.id;
                
                const isRemovable = image.isCustom || image.id > 10;
                const imgTag = `<img src="${image.src}" alt="${image.label}" 
                    onerror="this.src='${image.fallbackSrc || image.src}'; this.onerror=null;">`;
                
                // Special styling for dummy images
                const dummyClass = image.isDummy ? ' style="opacity: 0.6; border: 2px dashed var(--border);"' : '';
                
                imageElement.innerHTML = `
                    ${imgTag}
                    <div class="label"${dummyClass}>${image.label}</div>
                    ${!image.isDummy ? `<button class="pecs-edit-btn" onclick="editPECSLabel(${image.id})" title="Edit label">✎</button>` : ''}
                    ${isRemovable ? '<button class="pecs-remove-btn" onclick="removePECSFromLibrary(' + image.id + ')" title="Remove">×</button>' : ''}
                `;

                // Don't make dummy images draggable
                if (!image.isDummy) {
                    imageElement.addEventListener('dragstart', handleDragStart);
                    imageElement.addEventListener('touchstart', handleImageTouchStart);
                    imageElement.addEventListener('touchmove', handleImageTouchMove);
                    imageElement.addEventListener('touchend', handleImageTouchEnd);
                } else {
                    imageElement.style.cursor = 'default';
                    imageElement.draggable = false;
                }

                grid.appendChild(imageElement);
            });

            content.appendChild(grid);
            section.appendChild(header);
            section.appendChild(content);
            container.appendChild(section);
        }

        function updateCategoryDropdowns() {
            // Get all existing categories
            const allCategories = new Set(['People', 'Actions', 'Meal Time', 'Activities', 'Descriptors', 'Other']);
            
            // Add custom categories
            customCategories.forEach(cat => allCategories.add(cat));
            
            // Add categories from existing images
            imageLibrary.forEach(image => {
                if (image.category && !image.isDummy) {
                    allCategories.add(image.category);
                }
            });
            
            return Array.from(allCategories).sort();
        }

        function generateCategoryOptions(selectedCategory = '') {
            const categories = updateCategoryDropdowns();
            return categories.map(cat => 
                `<option value="${cat}" ${selectedCategory === cat ? 'selected' : ''}>${cat}</option>`
            ).join('');
        }

        function handleImageUpload(event) {
            const files = event.target.files;
            
            Array.from(files).forEach((file, index) => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        showImageRenameDialog(e.target.result, file.name, (newLabel, category) => {
                            const imageData = {
                                id: Date.now() + Math.random() + index,
                                label: newLabel,
                                src: e.target.result,
                                category: category,
                                isCustom: true,
                                originalFilename: file.name
                            };
                            imageLibrary.push(imageData);
                            renderImageLibrary();
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            event.target.value = '';
        }

        function editPECSLabel(imageId) {
            const image = imageLibrary.find(img => img.id == imageId);
            if (!image) return;
            
            const overlay = document.createElement('div');
            overlay.className = 'rename-modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'rename-modal';
            
            const categoryOptions = generateCategoryOptions(image.category);
            
            modal.innerHTML = `
                <div class="rename-modal-header">
                    <h3>Edit PECS Card</h3>
                    <button class="rename-modal-close" onclick="closeRenameModal()">&times;</button>
                </div>
                <div class="rename-modal-body">
                    <img src="${image.src}" alt="Preview" class="rename-preview-image">
                    <div>
                        <div class="form-group">
                            <label class="form-label">What should this card say?</label>
                            <input type="text" class="form-input" id="pecsLabel" value="${image.label}" placeholder="Enter word or phrase" maxlength="30">
                            <div class="rename-hint">This text will be spoken when the card is used</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-input" id="pecsCategory" list="categoryOptions" value="${image.category}" placeholder="Select or type category name">
                            <datalist id="categoryOptions">
                                ${categoryOptions}
                            </datalist>
                            <div class="rename-hint">Select existing category or type a new one</div>
                        </div>
                    </div>
                </div>
                <div class="rename-modal-footer">
                    <button class="btn btn-danger" onclick="closeRenameModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="testRenameLabel()">Test Sound</button>
                    <button class="btn btn-secondary" onclick="confirmEdit(${imageId})">Save Changes</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                const input = document.getElementById('pecsLabel');
                input.focus();
                input.select();
            }, 100);
            
            document.getElementById('pecsLabel').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmEdit(imageId);
                }
            });
        }

        function showImageRenameDialog(imageSrc, originalFilename, onConfirm) {
            const overlay = document.createElement('div');
            overlay.className = 'rename-modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'rename-modal';
            
            const suggestedName = originalFilename.split('.')[0].replace(/[_-]/g, ' ');
            
            // Generate dynamic category options including custom categories
            const categoryOptions = generateCategoryOptions();
            
            modal.innerHTML = `
                <div class="rename-modal-header">
                    <h3>Name Your PECS Card</h3>
                    <button class="rename-modal-close" onclick="closeRenameModal()">&times;</button>
                </div>
                <div class="rename-modal-body">
                    <img src="${imageSrc}" alt="Preview" class="rename-preview-image">
                    <div>
                        <div class="form-group">
                            <label class="form-label">What should this card say?</label>
                            <input type="text" class="form-input" id="pecsLabel" value="${suggestedName}" placeholder="Enter word or phrase" maxlength="30">
                            <div class="rename-hint">This text will be spoken when the card is used</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <input type="text" class="form-input" id="pecsCategory" list="categoryOptions" placeholder="Select or type category name">
                            <datalist id="categoryOptions">
                                ${categoryOptions}
                            </datalist>
                            <div class="rename-hint">Select existing category or type a new one</div>
                        </div>
                    </div>
                </div>
                <div class="rename-modal-footer">
                    <button class="btn btn-danger" onclick="closeRenameModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="testRenameLabel()">Test Sound</button>
                    <button class="btn btn-secondary" onclick="confirmRename()">Add to Library</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                const input = document.getElementById('pecsLabel');
                input.focus();
                input.select();
                
                // Set default category based on suggested name
                const categoryInput = document.getElementById('pecsCategory');
                if (suggestedName.toLowerCase().includes('eat') || suggestedName.toLowerCase().includes('drink') || suggestedName.toLowerCase().includes('food')) {
                    categoryInput.value = 'Meal Time';
                } else if (suggestedName.toLowerCase().includes('play') || suggestedName.toLowerCase().includes('game')) {
                    categoryInput.value = 'Activities';
                } else {
                    categoryInput.value = 'Other';
                }
            }, 100);
            
            window.currentRenameCallback = onConfirm;
            
            document.getElementById('pecsLabel').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmRename();
                }
            });
        }

        function closeRenameModal() {
            const overlay = document.querySelector('.rename-modal-overlay');
            if (overlay) {
                overlay.remove();
            }
            window.currentRenameCallback = null;
        }

        function testRenameLabel() {
            const label = document.getElementById('pecsLabel').value.trim();
            if (label) {
                speakPECSLabel(label);
            } else {
                alert('Please enter a label first!');
            }
        }

        function confirmRename() {
            const label = document.getElementById('pecsLabel').value.trim();
            let category = document.getElementById('pecsCategory').value.trim();
            
            if (!category) category = 'Other';
            
            // Add to custom categories if it's a new category
            const defaultCategories = ['People', 'Actions', 'Meal Time', 'Activities', 'Descriptors', 'Other'];
            if (!defaultCategories.includes(category)) {
                customCategories.add(category);
            }
            
            if (label) {
                if (window.currentRenameCallback) {
                    window.currentRenameCallback(label, category);
                }
                closeRenameModal();
                showNotification(`"${label}" added to library!`);
            } else {
                alert('Please enter a label for your PECS card!');
            }
        }

        function confirmEdit(imageId) {
            const label = document.getElementById('pecsLabel').value.trim();
            let category = document.getElementById('pecsCategory').value.trim();
            
            if (!category) category = 'Other';
            
            // Add to custom categories if it's a new category
            const defaultCategories = ['People', 'Actions', 'Meal Time', 'Activities', 'Descriptors', 'Other'];
            if (!defaultCategories.includes(category)) {
                customCategories.add(category);
            }
            
            if (label) {
                const image = imageLibrary.find(img => img.id == imageId);
                if (image) {
                    image.label = label;
                    image.category = category;
                    
                    // Update any instances in current sentence
                    currentSentence.forEach(sentenceImage => {
                        if (sentenceImage.id == imageId) {
                            sentenceImage.label = label;
                            sentenceImage.category = category;
                        }
                    });
                    
                    renderSentence();
                    renderImageLibrary();
                    closeRenameModal();
                    showNotification(`"${label}" updated successfully!`);
                }
            } else {
                alert('Please enter a label for your PECS card!');
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideInRight 0.3s ease-in reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 3000);
        }

        function handleDragStart(e) {
            draggedImage = e.currentTarget.dataset.imageId;
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            document.getElementById('sentenceArea').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            document.getElementById('sentenceArea').classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('sentenceArea').classList.remove('drag-over');
            
            if (draggedImage) {
                addImageToSentence(draggedImage);
                draggedImage = null;
            }
        }

        let touchStartPos = null;
        let touchImage = null;

        function handleImageTouchStart(e) {
            touchStartPos = {
                x: e.touches[0].clientX,
                y: e.touches[0].clientY
            };
            touchImage = e.currentTarget.dataset.imageId;
        }

        function handleImageTouchMove(e) {
            if (!touchStartPos) return;
            e.preventDefault();
        }

        function handleImageTouchEnd(e) {
            if (!touchStartPos || !touchImage) return;
            
            const touch = e.changedTouches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (element && (element.id === 'sentenceArea' || element.closest('#sentenceArea'))) {
                addImageToSentence(touchImage);
            }
            
            touchStartPos = null;
            touchImage = null;
        }

        function handleTouchStart(e) {}
        function handleTouchMove(e) {}
        function handleTouchEnd(e) {}

        function addImageToSentence(imageId) {
            try {
                const image = imageLibrary.find(img => img.id == imageId);
                if (image) {
                    currentSentence.push(image);
                    renderSentence();
                    
                    if (image.label) {
                        speakPECSLabel(image.label);
                    }
                    
                    const sentenceArea = document.getElementById('sentenceArea');
                    if (sentenceArea) {
                        sentenceArea.style.backgroundColor = '#dcfce7';
                        setTimeout(() => {
                            sentenceArea.style.backgroundColor = '';
                        }, 300);
                    }
                }
            } catch (error) {
                console.error('Error adding image to sentence:', error);
            }
        }

        function renderSentence() {
            const sentenceArea = document.getElementById('sentenceArea');
            sentenceArea.innerHTML = '';
            
            if (currentSentence.length === 0) {
                sentenceArea.classList.add('empty');
                return;
            }
            
            sentenceArea.classList.remove('empty');
            
            currentSentence.forEach((image, index) => {
                const imageElement = document.createElement('div');
                imageElement.className = 'sentence-image';
                imageElement.innerHTML = `
                    <img src="${image.src}" alt="${image.label}">
                    <button class="remove-btn" onclick="removeFromSentence(${index})">×</button>
                `;
                sentenceArea.appendChild(imageElement);
            });
        }

        function removeFromSentence(index) {
            currentSentence.splice(index, 1);
            renderSentence();
        }

        function clearSentence() {
            currentSentence = [];
            renderSentence();
        }

        function speakSentence() {
            try {
                if (currentSentence.length === 0) {
                    alert('Please add some pictures to your sentence first!');
                    return;
                }
                
                const text = currentSentence.map(img => img.label || '').filter(label => label.trim() !== '').join(' ');
                
                if (!text || text.trim() === '') {
                    alert('No text to speak!');
                    return;
                }
                
                const sentenceArea = document.getElementById('sentenceArea');
                if (sentenceArea) {
                    sentenceArea.style.backgroundColor = '#dbeafe';
                    sentenceArea.style.borderColor = '#3b82f6';
                }
                
                speakText(text, {
                    rate: 0.75,
                    pitch: 1.0,
                    volume: 0.95,
                    addPauses: true,
                    onStart: () => {
                        try {
                            const speakBtn = document.querySelector('.speak-btn');
                            if (speakBtn) {
                                speakBtn.disabled = true;
                                speakBtn.textContent = 'Speaking...';
                            }
                        } catch (error) {
                            console.error('Error in onStart:', error);
                        }
                    },
                    onEnd: () => {
                        try {
                            const sentenceArea = document.getElementById('sentenceArea');
                            if (sentenceArea) {
                                sentenceArea.style.backgroundColor = '';
                                sentenceArea.style.borderColor = '';
                            }
                            
                            const speakBtn = document.querySelector('.speak-btn');
                            if (speakBtn) {
                                speakBtn.disabled = false;
                                speakBtn.textContent = 'Speak';
                            }
                        } catch (error) {
                            console.error('Error in onEnd:', error);
                        }
                    }
                });
            } catch (error) {
                console.error('Error in speakSentence:', error);
                
                try {
                    const sentenceArea = document.getElementById('sentenceArea');
                    if (sentenceArea) {
                        sentenceArea.style.backgroundColor = '';
                        sentenceArea.style.borderColor = '';
                    }
                    
                    const speakBtn = document.querySelector('.speak-btn');
                    if (speakBtn) {
                        speakBtn.disabled = false;
                        speakBtn.textContent = 'Speak';
                    }
                } catch (resetError) {
                    console.error('Error resetting UI:', resetError);
                }
            }
        }

        function speakText(text, options = {}) {
            if (!('speechSynthesis' in window)) {
                alert('Speech synthesis not supported in this browser');
                return;
            }
            
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = options.rate || 0.8;
            utterance.pitch = options.pitch || 1.0;
            utterance.volume = options.volume || 0.9;
            
            if (options.addPauses && text.includes(' ')) {
                const words = text.split(' ');
                utterance.text = words.join(', ');
            }
            
            utterance.onstart = () => {
                if (options.onStart) options.onStart();
            };
            
            utterance.onend = () => {
                if (options.onEnd) options.onEnd();
            };
            
            speechSynthesis.speak(utterance);
        }

        function speakPECSLabel(label) {
            speakText(label, {
                rate: 0.8,
                pitch: 1.0,
                volume: 0.8
            });
        }

        function removePECSFromLibrary(imageId) {
            const image = imageLibrary.find(img => img.id == imageId);
            if (!image) return;
            
            const confirmMessage = `Remove "${image.label}" from library?`;
            if (!confirm(confirmMessage)) return;
            
            const index = imageLibrary.findIndex(img => img.id == imageId);
            if (index !== -1) {
                imageLibrary.splice(index, 1);
                
                const sentenceIndex = currentSentence.findIndex(img => img.id == imageId);
                if (sentenceIndex !== -1) {
                    currentSentence.splice(sentenceIndex, 1);
                    renderSentence();
                }
                
                renderImageLibrary();
                showNotification(`"${image.label}" removed from library`);
            }
        }

        function showCreateCategoryDialog() {
            const overlay = document.createElement('div');
            overlay.className = 'rename-modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'rename-modal';
            
            modal.innerHTML = `
                <div class="rename-modal-header">
                    <h3>Create New Category</h3>
                    <button class="rename-modal-close" onclick="closeRenameModal()">&times;</button>
                </div>
                <div class="rename-modal-body" style="grid-template-columns: 1fr;">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Category Name</label>
                            <input type="text" class="form-input" id="newCategoryName" placeholder="Enter category name" maxlength="20">
                            <div class="rename-hint">Choose a descriptive name for your new category</div>
                        </div>
                    </div>
                </div>
                <div class="rename-modal-footer">
                    <button class="btn btn-danger" onclick="closeRenameModal()">Cancel</button>
                    <button class="btn btn-secondary" onclick="confirmCreateCategory()">Create Category</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                const input = document.getElementById('newCategoryName');
                input.focus();
            }, 100);
            
            document.getElementById('newCategoryName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmCreateCategory();
                }
            });
        }

        function confirmCreateCategory() {
            const categoryName = document.getElementById('newCategoryName').value.trim();
            
            if (!categoryName) {
                alert('Please enter a category name!');
                return;
            }
            
            // Check if category already exists
            const existingCategories = new Set();
            imageLibrary.forEach(image => {
                if (image.category) {
                    existingCategories.add(image.category);
                }
            });
            
            // Add default categories
            ['People', 'Actions', 'Meal Time', 'Activities', 'Descriptors', 'Other'].forEach(cat => {
                existingCategories.add(cat);
            });
            
            // Add custom categories
            customCategories.forEach(cat => {
                existingCategories.add(cat);
            });
            
            if (existingCategories.has(categoryName)) {
                alert('A category with this name already exists!');
                return;
            }
            
            // Add to custom categories
            customCategories.add(categoryName);
            
            // Create a dummy image to force the category to appear
            const dummyImage = {
                id: Date.now() + Math.random(),
                label: 'Empty Category',
                src: createSimpleIcon('empty', 'Empty Category'),
                category: categoryName,
                isCustom: true,
                isDummy: true
            };
            imageLibrary.push(dummyImage);
            
            closeRenameModal();
            renderImageLibrary();
            showNotification(`Category "${categoryName}" created! Add images to this category.`);
        }

        function editCategoryName(oldCategoryName) {
            const overlay = document.createElement('div');
            overlay.className = 'rename-modal-overlay';
            
            const modal = document.createElement('div');
            modal.className = 'rename-modal';
            
            modal.innerHTML = `
                <div class="rename-modal-header">
                    <h3>Edit Category Name</h3>
                    <button class="rename-modal-close" onclick="closeRenameModal()">&times;</button>
                </div>
                <div class="rename-modal-body" style="grid-template-columns: 1fr;">
                    <div>
                        <div class="form-group">
                            <label class="form-label">Category Name</label>
                            <input type="text" class="form-input" id="editCategoryName" value="${oldCategoryName}" placeholder="Enter category name" maxlength="20">
                            <div class="rename-hint">Update the name for this category</div>
                        </div>
                    </div>
                </div>
                <div class="rename-modal-footer">
                    <button class="btn btn-danger" onclick="closeRenameModal()">Cancel</button>
                    <button class="btn btn-secondary" onclick="confirmEditCategory('${oldCategoryName}')">Save Changes</button>
                </div>
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            
            setTimeout(() => {
                const input = document.getElementById('editCategoryName');
                input.focus();
                input.select();
            }, 100);
            
            document.getElementById('editCategoryName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmEditCategory(oldCategoryName);
                }
            });
        }

        function confirmEditCategory(oldCategoryName) {
            const newCategoryName = document.getElementById('editCategoryName').value.trim();
            
            if (!newCategoryName) {
                alert('Please enter a category name!');
                return;
            }
            
            if (newCategoryName === oldCategoryName) {
                closeRenameModal();
                return;
            }
            
            // Check if new category name already exists
            const categories = {};
            imageLibrary.forEach(image => {
                const category = image.category || 'Other';
                if (!categories[category]) {
                    categories[category] = [];
                }
            });
            
            if (categories[newCategoryName]) {
                alert('A category with this name already exists!');
                return;
            }
            
            // Update all images in this category
            imageLibrary.forEach(image => {
                if (image.category === oldCategoryName) {
                    image.category = newCategoryName;
                }
            });
            
            // Update custom categories set
            customCategories.delete(oldCategoryName);
            customCategories.add(newCategoryName);
            
            closeRenameModal();
            renderImageLibrary();
            showNotification(`Category renamed to "${newCategoryName}"`);
        }

        function deleteCategory(categoryName) {
            const confirmMessage = `Delete the "${categoryName}" category?\n\nAll PECS cards in this category will be moved to "Other".`;
            if (!confirm(confirmMessage)) return;
            
            // Move all images from this category to "Other"
            imageLibrary.forEach(image => {
                if (image.category === categoryName) {
                    image.category = 'Other';
                }
            });
            
            // Remove from custom categories
            customCategories.delete(categoryName);
            
            renderImageLibrary();
            showNotification(`Category "${categoryName}" deleted`);
        }
    </script>
</body>
</html>